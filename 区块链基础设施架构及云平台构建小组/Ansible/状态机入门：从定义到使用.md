# 状态机入门：从定义到使用 

状态机是什么？状态机应该如何去应用呢？状态机可以对业务状态进行梳理，一目了然，之后可以根据业务场景不断增加。

在工作过程中，意外接触了一个词——“状态机”，这是个什么意思，可以为我们做产品提供怎样的用处？

**作为产品，为什么需要学习状态机呢？**

在刚进入公司的时候，根据公司产品做流程图的时候，发现自己经常会漏了这样或那样的状态，导致整体流程会有问题。后来知道了状态机这样的东西，发现用这幅图就可以很清晰的表达整个状态的流转。当然这个不是做好一款产品的必备品，但是却可以让你更加轻松的同技术等人员交流。

一、什么是状态机？

就是就是状态转移图。

如果流程围绕某个事物的状态变化进行，显而易见，该轮到状态机图上场了。一个状态机图中只描述一个事物，该事物有多个状态，不同的动作作用到状态上导致状态的转换。

举个最简单的例子：

人有三个状态：健康、感冒、康复中。

触发的条件有淋雨(t1)、吃药(t2)、打针(t3)、休息(t4)。

所以状态机就是健康->(t4)->健康；健康->(t1)->感冒；感冒->(t3)->健康；感冒->(t2)->康复中；康复中->(t4)->健康等等。就是这样状态在不同的条件下，跳转到自己或不同状态的图。

状态机可归纳为4个要素，即**现态、条件、动作、次态**。这样的归纳，主要是出于对状态机的内在因果关系的考虑。**“现态”和“条件”是因，“动作”和“次态”是果**。

详解如下：

1. 现态：是指当前所处的状态。
2. 条件：又称为“事件”，当一个条件被满足，将会触发一个动作，或者执行一次状态的迁移。
3. 动作：条件满足后执行的动作，动作执行完毕后，可以迁移到新的状态，也可以仍旧保持原状态。动作不是必需的，当条件满足后，也可以不执行任何动作，直接迁移到新状态。
4. 次态：条件满足后要迁往的新状态。“次态”是相对于“现态”而言的，“次态”一旦被激活，就转变成新的“现态”了。

在了解关于状态机的文章后，结合自己的平时的学习总结，我发现：**在平时的业务过程中，判断即对应状态机理论中的条件，我们做什么操作改变状态即理论中的动作**，同时状态必须要有始有终，否则会出现状态卡住，无法继续正常推进。

状态机的开始一般用空心圆表示，代表状态图的起始位置。

![img](http://5b0988e595225.cdn.sohucs.com/images/20180508/d85d69eb32524248948b04def94de314.jpeg)

结尾一般用实心圆点表示，是一个状态的终止点。

![img](http://5b0988e595225.cdn.sohucs.com/images/20180508/02677f6905fd4ffdbbf5129eff72cd78.jpeg)

二、那么状态机怎样去应用呢？

以物理课学的灯泡图为例：就是一个最基本的小型状态机，这个例子人人里的很多大神都已经举过了，这里就简单说下。

![img](http://5b0988e595225.cdn.sohucs.com/images/20180508/18bd7c123ed34779b7a987181ad226ed.jpeg)

这里就是两个状态：①打开开关，灯泡亮；②关闭开关，灯泡灭。

可以画出以下的状态机图：

![img](http://5b0988e595225.cdn.sohucs.com/images/20180508/0e3c08e476844dd99026db2709c03464.jpeg)

如果进度卡住，该怎么办？

这里有个比较形象的案例就是淘宝的自动确认收货，卖家发货后状态变为待收货，若买家迟迟不点确认收货的话，那么流程就停止在这里，卖家也迟迟收不到货款。

因此，在这里，淘宝做了一个条件，判断时间是否达到15天，如果达到15天，做出确认收货的动作，使得状态得到流转。

以小灯泡为例：假设为了节约，小灯泡开了超过8个小时就自动关闭，除非再次做打开开关的操作，画出此时的状态机图如下：

![img](http://5b0988e595225.cdn.sohucs.com/images/20180508/258a535c301c4c6ca40a5877f5d2707a.jpeg)

同样的状态判断应用了很多场景，例如：患者购买服务或商品时，订单由待支付-已支付的状态中的通过时间条件来实现状态得到继续流转。

但是，判断不是状态机必要的，如：正常小灯泡的两种状态，可以不需要经过判断。起始和终止状态可能是相同的，也可能是不同的，即同一种状态可能是起始状态，也可能为终止状态。

在这里以外卖app为例：制作了一个订单的简单的状态机图，以订单的状态变更推动。

![img](http://5b0988e595225.cdn.sohucs.com/images/20180508/5dde037d12804ddabdb50f69a5080fd8.png)

三、总结

新入门时，对状态机和业务流程图总是傻傻分不清楚，因此对于状态机和流程图进行了了解和归纳。

总的来说，状态机图和业务流程图有些类似，但是又有不同：

- 两者是两种不同的思维方式；
- 两者思考的出发点不一样，因而两者所表达的目的也是不同的；
- 两者的各个节点都是不同的，流程图为动作，状态机为状态。

一般情况下，我们使用的均为有限状态机。状态机可以对业务状态进行梳理，一目了然，之后可以根据业务场景不断增加。

同时，使用状态机和相关人员，尤其是开发，进行表达时，也可以更加清晰，提升沟通效率。



# 有限状态机FSM的原理与GO的实现

有限状态机(Finite-state machine, 简写FSM)又可以称作有限状态自动机。它必须是可以附着在某种事物上的，且该事物的状态是有限的，通过某些触发事件，会让其状态发生转换。为此，有限状态机就是描述这些有限的状态和触发事件及转换行为的数学模型。

## 有限状态机组成

**有限状态机有两个必要的特点，一是离散的，二是有限的。基于这两点，现实世界上绝大多数事物因为复杂的状态而无法用有限状态机表示。**

而描述事物的有限状态机模型的元素由以下组成：

- 状态(State)：事物的状态，包括初始状态和所有事件触发后的状态
- 事件(Event)：触发状态变化或者保持原状态的事件
- 行为或转换(Action/Transition)：执行状态转换的过程
- 检测器(Guard)：检测某种状态要转换成另一种状态的条件是否满足

## 应用领域

除了刚刚介绍的数学模型应用，有限状态机在许多不同领域都有重要应用，包括电气工程、语言学、计算机科学、哲学、生物学、数学和逻辑学。有限状态机归属于自动机理论，下面的自动机理论的领域分层图中就可以看出，越是外层的概念越复杂。

![img](https:////upload-images.jianshu.io/upload_images/5709266-791b738cda6aa5f2.png?imageMogr2/auto-orient/strip|imageView2/2/w/440/format/webp)

## 有限状态机的举例

我们就拿身边最经典的电风扇来举例。假如电风扇有4个按钮，分别是关、1档、2档和3档，关按钮负责关闭电风扇，也就是停止电风扇的转动；而1、2、3档都可以让电风扇开启，且风扇转动的速度不一样，产生的风力也不一样。

这时我们判断出风扇的4个状态，分别是关闭(poweroff)、1档(1st gear)、2档(2nd gear)、3档(3rd gear)。而4个按钮的按下操作可以影响电风扇的状态。下面用状态图来说明：

![img](https:////upload-images.jianshu.io/upload_images/5709266-b2eab09221fb9152.png?imageMogr2/auto-orient/strip|imageView2/2/w/569/format/webp)

如果看不清楚，还有状态转移表

![img](https:////upload-images.jianshu.io/upload_images/5709266-d02202dfe551e897.png?imageMogr2/auto-orient/strip|imageView2/2/w/677/format/webp)

为了更直观的让程序员了解FSM具体有什么用，我将电风扇的有限状态机用程序来演示。

## Go语言下的有限状态机

一共2个文件，fsm.go是有限状态机的抽象定义，main.go里是有限状态机在电风扇上的具体状态呈现，代码如下：



```go
// fsm.go
package main

import (
    "fmt"
    "sync"
)

type FSMState string            // 状态
type FSMEvent string            // 事件
type FSMHandler func() FSMState // 处理方法，并返回新的状态

// 有限状态机
type FSM struct {
    mu       sync.Mutex                           // 排他锁
    state    FSMState                             // 当前状态
    handlers map[FSMState]map[FSMEvent]FSMHandler // 处理地图集，每一个状态都可以出发有限个事件，执行有限个处理
}

// 获取当前状态
func (f *FSM) getState() FSMState {
    return f.state
}

// 设置当前状态
func (f *FSM) setState(newState FSMState) {
    f.state = newState
}

// 某状态添加事件处理方法
func (f *FSM) AddHandler(state FSMState, event FSMEvent, handler FSMHandler) *FSM {
    if _, ok := f.handlers[state]; !ok {
        f.handlers[state] = make(map[FSMEvent]FSMHandler)
    }
    if _, ok := f.handlers[state][event]; ok {
        fmt.Printf("[警告] 状态(%s)事件(%s)已定义过", state, event)
    }
    f.handlers[state][event] = handler
    return f
}

// 事件处理
func (f *FSM) Call(event FSMEvent) FSMState {
    f.mu.Lock()
    defer f.mu.Unlock()
    events := f.handlers[f.getState()]
    if events == nil {
        return f.getState()
    }
    if fn, ok := events[event]; ok {
        oldState := f.getState()
        f.setState(fn())
        newState := f.getState()
        fmt.Println("状态从 [", oldState, "] 变成 [", newState, "]")
    }
    return f.getState()
}

// 实例化FSM
func NewFSM(initState FSMState) *FSM {
    return &FSM{
        state:    initState,
        handlers: make(map[FSMState]map[FSMEvent]FSMHandler),
    }
}
```



```go
// main.go
package main

import (
    "fmt"
)

var (
    Poweroff        = FSMState("关闭")
    FirstGear       = FSMState("1档")
    SecondGear      = FSMState("2档")
    ThirdGear       = FSMState("3档")
    PowerOffEvent   = FSMEvent("按下关闭按钮")
    FirstGearEvent  = FSMEvent("按下1档按钮")
    SecondGearEvent = FSMEvent("按下2档按钮")
    ThirdGearEvent  = FSMEvent("按下3档按钮")
    PowerOffHandler = FSMHandler(func() FSMState {
        fmt.Println("电风扇已关闭")
        return Poweroff
    })
    FirstGearHandler = FSMHandler(func() FSMState {
        fmt.Println("电风扇开启1档，微风徐来！")
        return FirstGear
    })
    SecondGearHandler = FSMHandler(func() FSMState {
        fmt.Println("电风扇开启2档，凉飕飕！")
        return SecondGear
    })
    ThirdGearHandler = FSMHandler(func() FSMState {
        fmt.Println("电风扇开启3档，发型被吹乱了！")
        return ThirdGear
    })
)

// 电风扇
type ElectricFan struct {
    *FSM
}

// 实例化电风扇
func NewElectricFan(initState FSMState) *ElectricFan {
    return &ElectricFan{
        FSM: NewFSM(initState),
    }
}

// 入口函数
func main() {

    efan := NewElectricFan(Poweroff) // 初始状态是关闭的
    // 关闭状态
    efan.AddHandler(Poweroff, PowerOffEvent, PowerOffHandler)
    efan.AddHandler(Poweroff, FirstGearEvent, FirstGearHandler)
    efan.AddHandler(Poweroff, SecondGearEvent, SecondGearHandler)
    efan.AddHandler(Poweroff, ThirdGearEvent, ThirdGearHandler)
    // 1档状态
    efan.AddHandler(FirstGear, PowerOffEvent, PowerOffHandler)
    efan.AddHandler(FirstGear, FirstGearEvent, FirstGearHandler)
    efan.AddHandler(FirstGear, SecondGearEvent, SecondGearHandler)
    efan.AddHandler(FirstGear, ThirdGearEvent, ThirdGearHandler)
    // 2档状态
    efan.AddHandler(SecondGear, PowerOffEvent, PowerOffHandler)
    efan.AddHandler(SecondGear, FirstGearEvent, FirstGearHandler)
    efan.AddHandler(SecondGear, SecondGearEvent, SecondGearHandler)
    efan.AddHandler(SecondGear, ThirdGearEvent, ThirdGearHandler)
    // 3档状态
    efan.AddHandler(ThirdGear, PowerOffEvent, PowerOffHandler)
    efan.AddHandler(ThirdGear, FirstGearEvent, FirstGearHandler)
    efan.AddHandler(ThirdGear, SecondGearEvent, SecondGearHandler)
    efan.AddHandler(ThirdGear, ThirdGearEvent, ThirdGearHandler)

    // 开始测试状态变化
    efan.Call(ThirdGearEvent)  // 按下3档按钮
    efan.Call(FirstGearEvent)  // 按下1档按钮
    efan.Call(PowerOffEvent)   // 按下关闭按钮
    efan.Call(SecondGearEvent) // 按下2档按钮
    efan.Call(PowerOffEvent)   // 按下关闭按钮
}
```

执行后返回：



```bash
电风扇开启3档，发型被吹乱了！
状态从 [ 关闭 ] 变成 [ 3档 ]
电风扇开启1档，微风徐来！
状态从 [ 3档 ] 变成 [ 1档 ]
电风扇已关闭
状态从 [ 1档 ] 变成 [ 关闭 ]
电风扇开启2档，凉飕飕！
状态从 [ 关闭 ] 变成 [ 2档 ]
电风扇已关闭
状态从 [ 2档 ] 变成 [ 关闭 ]
```



作者：陈康stozen
链接：https://www.jianshu.com/p/37281543f506
来源：简书
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。



在工作过程中，意外接触了一个词——“状态机”，这是个什么意思，可以为我们做产品提供怎样的用处？这篇文章就是初识状态机之后的学习感悟。

作为产品，为什么需要学习状态机呢？在刚进入公司的时候，根据公司产品做流程图的时候，发现自己经常会漏了这样或那样的状态，导致整体流程会有问题，后来知道了状态机这样的东西，发现用这幅图就可以很清晰的表达整个状态的流转，当然这个不是做好一款产品的必备品，但是却可以让你更加轻松的同技术等人员交流。

# 什么是状态机？

据百度百科，就是状态转移图。举个最简单的例子。人有三个状态健康，感冒，康复中。触发的条件有淋雨(t1)，吃药(t2)，打针(t3)，休息(t4)。所以状态机就是健康->(t4)->健康;健康->(t1)->感冒;感冒->(t3)->健康;感冒->(t2)->康复中;康复中->(t4)->健康，等等。就是这样状态在不同的条件下跳转到自己或不同状态的图。

状态机可归纳为4个要素，即现态、条件、动作、次态。这样的归纳，主要是出于对状态机的内在因果关系的考虑。“现态”和“条件”是因，“动作”和“次态”是果。详解如下：

①现态：是指当前所处的状态。

②条件：又称为“事件”，当一个条件被满足，将会触发一个动作，或者执行一次状态的迁移。

③动作：条件满足后执行的动作。动作执行完毕后，可以迁移到新的状态，也可以仍旧保持原状态。动作不是必需的，当条件满足后，也可以不执行任何动作，直接迁移到新状态。

④次态：条件满足后要迁往的新状态。“次态”是相对于“现态”而言的，“次态”一旦被激活，就转变成新的“现态”了。

在阅读了浪子PRD关于状态机的文章后，结合自己的学习总结，我发现在平时的业务过程中，判断即对应状态机理论中的条件，我们做什么操作改变状态即理论中的动作，同时状态必须要有始有终，否则会出现状态卡住，无法继续正常推进。

## **那么状态机怎样去应用呢？**

以物理课学的灯泡图为例，就是一个最基本的小型状态机



![img](https:////upload-images.jianshu.io/upload_images/6306801-7c20443552612e9c.jpg?imageMogr2/auto-orient/strip|imageView2/2/w/300/format/webp)

这里就是两个状态：①打开开关，灯泡亮，②关闭开关，灯泡灭

可以画出以下的状态机图



![img](https:////upload-images.jianshu.io/upload_images/6306801-c4d597498dc738f4.jpg?imageMogr2/auto-orient/strip|imageView2/2/w/249/format/webp)

如果进度卡住，该怎么办？这里有个比较形象的案例就是淘宝的自动确认收货，卖家发货后状态变为待收货，若买家迟迟不点确认收货的话，那么流程就停止在这里，卖家也迟迟收不到货款，因此，在这里，淘宝做了一个条件，判断时间是否达到15天，如果达到15天，做出确认收货的动作，使得状态得到流转。以小灯泡为例，假设为了节约，小灯泡开了超过8个小时就自动关闭，除非再次做打开开关的操作，画出此时的状态机图如下



![img](https:////upload-images.jianshu.io/upload_images/6306801-d64626d58b998b28.jpg?imageMogr2/auto-orient/strip|imageView2/2/w/289/format/webp)

但是，

判断不是状态机必要的，如正常小灯泡的两种状态，可以不需要经过判断

起始和终止状态可能是相同的，也可能是不同的，即同一种状态可能是起始状态，也可能为终止状态

在这里以美团外卖为例，制作了一个简单的状态机图

**
**

![img](https:////upload-images.jianshu.io/upload_images/6306801-e16015aae6725083.jpg?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp)

# **总结**

状态机图和业务流程图有些类似，但是又有不同：

1、两种不同的思维方式

2、两者思考的出发点不一样，因而两者所表达的目的也是不同的

3、两者的各个节点都是不同的，流程图为动作，状态机为状态

状态机可以对业务状态进行梳理，一目了然，之后可以根据业务场景不断增加。同时，使用状态机和相关人员进行表达时，也可以更加清晰，提升沟通效率。



作者：卉卉卉卉子
链接：https://www.jianshu.com/p/403f750e1d3a
来源：简书
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。



状态机是无论科研探索还是科技应用方面都非常重要的一种分析工具。几乎在所有涉及到随时间演化的问题中，都可以找到状态机的用武之地。这里作为一个普及性的介绍文章，我们主要针对最基础形式的状态机进行一些深入浅出式的提要介绍，以期能够令读者对状态机有一定的基础认识，能够理解状态机分析方法的思考路线，并掌握一些最基本形式的状态机画法。

本文将会从三个主要角度展开介绍，分别为：

- 简要介绍一下状态机的各个应用场景
- 阐明状态的含义
- 介绍状态机模型的基本概念和图示画法
- 大体浏览一下最基本最常见的几种状态机画法

其中我们会用较大的篇幅进行状态以及状态机的概念辨析。因为在实际应用中，由于状态及状态机概念的错误理解而造成的绘图错误占了各种错误原因的极大比例，也是初学者最难逾越的最大难关。因此请读者无比潜心静气仔细理解这部分所展开的辨析，以便以后的使用中能够轻松应对。

# 一、现实中的状态机实例

在现实应用中，状态机的身影遍布科技应用的方方面面。从物理学中的物质三态转换关系



![img](https:////upload-images.jianshu.io/upload_images/286746-afe637564e3199ab.png?imageMogr2/auto-orient/strip|imageView2/2/w/600/format/webp)

物质三态转化关系图

到环境科学中的碳循环



![img](https:////upload-images.jianshu.io/upload_images/286746-d124602766144df8.png?imageMogr2/auto-orient/strip|imageView2/2/w/460/format/webp)

碳循环, 来自[wikipedia](https://en.wikipedia.org/wiki/Carbon_cycle)

从数字电路中的JK触发器



![img](https:////upload-images.jianshu.io/upload_images/286746-8d2fd76e0481e301.png?imageMogr2/auto-orient/strip|imageView2/2/w/430/format/webp)

J-K 触发器状态图

图书馆藏书的生命周期分析



![img](https:////upload-images.jianshu.io/upload_images/286746-4b122b57a80c6bf8.png?imageMogr2/auto-orient/strip|imageView2/2/w/625/format/webp)

馆藏图书状态图

乃至保障我们天天上网所不可获取TCP网络通讯协议的实现状态图



![img](https:////upload-images.jianshu.io/upload_images/286746-831ce6f976c0aa39.png?imageMogr2/auto-orient/strip|imageView2/2/w/544/format/webp)

TCP状态转换图

仅由上述寥寥数例，便可窥见状态机的广泛应用。

# 二、什么是状态、什么是状态机

日常语言中，状态一词的概念往往是人们通过反复大量的接触而建立的经验性归纳概念。一旦谈及状态，想要通过其内涵为它建立一个较为清晰的定义对普通人而言往往是似乎乎之欲出确有无法准确遣辞达意的一件事情。

在数学、物理学以及应用科学领域，各种不同的状态模型内都有自己关于对“状态”的看法，比较经典的例如

- 经典力学中的坐标、动量状态描述，参见[哈密顿力学](https://link.jianshu.com?t=ttps://en.wikipedia.org/wiki/Hamiltonian_mechanics)。
- 量子力学中的[量子态](https://link.jianshu.com?t=https://en.wikipedia.org/wiki/Quantum_state)。
- 热力学中的[态函数](https://link.jianshu.com?t=https://en.wikipedia.org/wiki/State_function)。
- 基础计算理论中的[图灵机](https://link.jianshu.com?t=https://en.wikipedia.org/wiki/Turing_machine)中所定义的状态。
- 数理语言学中的度量语料特征的[字频统计](https://link.jianshu.com?t=https://en.wikipedia.org/wiki/Letter_frequency)中的处理机状态。
- ……

## 1. 一般化的状态定义及引申理解

然而，进一步厘清以获得一个更加一般化的关于状态的认识，对于我们准确理解状态机概念是十分必要的。在此，本文尝试就我们下面所要讨论的范围内的问题，提出一个相对抽象度更高的一个状态的概念，以便于后续的讨论。

下面请同作者一道，花一些时间纠结于“是”与“非”这类的问题上。请相信，概念的厘清将会为我们准确理解并运用状态机方法带来决定性的支撑。

> __ 一个讨论对象的某些方面的特征在某些时刻，会具有同其它时刻之间相异的一些区别。刻画这种同一对象在不同时刻该方面特征间区别的工具即为状态，称之为该对象在的该方面特征的状态。 __

这个定义，其核心结构为

> 刻画……区别……的工具即为状态

同时通过三个限定结构

> - 同一对象

- 不同时刻
- 该方面特征

指出了状态概念的几个必备要件。

为了进一步帮助理解上述定义，可以考虑一下通过几个从此引申的辨析。

### (1) 状态从属于一个特定的对象

不同对象的状态可能在取值上相等，但一定不是同一状态，因为它们的从属对象不同。

所谓同一状态，外在的表现必然是无论何时所取得值都是相等的。

> #### 例如

灯的颜色状态可能在某时是“红色”，苹果的颜色状态也可能在某时是“红色”，这种情况下两者的值是相等的。但显然红灯的颜色状态和红苹果的颜色状态不是同一个状态。它们的取值不会永远相等。

由此进一步引申的一个思考技巧是

> **讨论状态时必须明确无误的指明状态所从属的对象，且大多的语境下不应轻易变换这个从属对象**

这里所谓的目标对象，可以是实际存在的物，也可能是某种事件、某种过程，而且在实际运用中后者居多。

> #### 例如

- 讨论苹果的颜色变化问题时，目标对象是苹果。
- 讨论一场战役的进展时，目标对象是战役这个事件本身，它的可能取值包含：策划中、部署中、交战中、已结束等。
- 讨论一个审批业务的进程时，则目标对象是此业务进程本身，可能是：申请材料准备中，申请已提交正在审核，审核已通过，审核被拒绝等。

### (2) 一个对象的状态可能随时间变化

一个对象的状态在不同时刻可能取不同的值，也可能取相同的值。但只要所讨论的对象没有变化、所讨论的方面没有变化，那么这个不同时刻的状态就没有在同一性上发生变化，而仅仅是取值可能发生了变化。

> #### 例如

电灯的工作状态在通电时是“亮”，在不通电时是“灭”。

** 状态随时间变化这个事实是整个状态机方法的中心要点，也正是因为这个，讨论状态才具有了它的必要性。**

状态取值随时间的变化，称为**状态的流转**。变化前的状态值称为**流出状态**，变化后的状态值称为**流入状态**。

大多数的情况下，状态的流转并不是自发的，而是在满足某些条件的情况下触发的，这种触发条件称为**事件**。在没有发生指明的事件时，状态将会保持原有的值，直到触发事件发生。

> #### 例如

- 电灯的“亮”与“暗”之间的转换，是“通电”和“停电”事件所触发的。
- 一个申请表单的状态从“申请中”变换到“审核中”的状态流转是“申请人提交申请”这个事件所触发的。

若一个状态取值在不同的条件下可能流转到不同的流入状态，那么这个状态的流转便是选择性的。

> #### 例如

考虑台式电话机的工作状态。若观察“话筒已提起”这个状态值，若发生“用户挂回话筒”事件，则话机的状态将转换为“已挂机”。但若发生“用户拨号”事件，那么话机状态则将进入“电话接通中”。

当然也存在无序任何触发条件而发生的自发性流转。这种情况下，流出状态将会是瞬时的，经历一个瞬间后便会转换为自发流转的流入状态。这种具有自发流转的流出状态，称为**瞬态**。

实际上，这里的瞬间所指并不见得一定便是人类所能够体验的所谓足够短的时间。而是指对于所考察的问题，此种流转的条件是不被关心的。因此这个瞬间可能确实非常短，也可能实际上很长久。

> #### 例如

- 闪电放电过程，若不关心放电的电量因素，那么“放电中”转换为“放电后”这个流转的条件“电量释放完毕”便是不被关心的，便可将这个流转视为自发流转，把“放电中”视为“瞬态”。
- 公文收发管理，若关注的中心在公文的收与发的过程，而不关心中间的机要通讯过程，那么一个公文从“已发出”到“办理接收手续中”的流转条件“公文送达接受处”便是不被关心的触发条件，那么即可视“已发出”为瞬态。这种情况下，也许公文的传递过程实际上是几天乃至几周都可以。

瞬态沿自发性流转变化是一个必然的过程。因此不存在统一个瞬态具有多条不同目的地的自发流转的情况。同样，瞬态上也不存在其它条件性流转的可能。瞬态只能具有一个唯一的自发性流转。

在大多数情况中，除非具有相当强烈的需求需要讨论瞬态本身同其对应的流入态之间的区别，否则单独设置一个瞬态是没有必要的，往往可以和之后的流入态进行合并处理。这是自发性流转和瞬态并不常见的原因。

### (3) 一个对象的状态可以是连续变化的，也可能是跳跃取值离散变化的

> #### 例如

- 灯丝老化问题中，灯丝的老化状态从全新到最终的完全报废，若以老化程度0%到100%衡量，老化过程中某一个时刻，老化程度可能取 [0%，100%] 之间的任何一个实数。
- 门禁系统的工作状态，简单的可以分为“闭锁”、“开启”两个分立的状态。

依照所考察的对象的状态的这种连续和离散取值的区别，可以比较简单的将状态机分为**连续状态机**、**离散状态机**。而离散状态机中，又可根据可能出现的状态的总数量分为**有限状态机**和**无限离散状态机**。

> ### 例如

- 前述经典物理中的哈密顿理学系统，采用坐标、动量共轭坐标系统，整体上所描述的便是一个连续状态机的问题。
- 理想的全加器，具有无穷位的示数能力，可能的状态遍布整个自然数范围，是一个无限离散状态机。
- 非理想全加器，只能够提供有限位的示数能力，所能够表达的自然数加法仅仅限制在其有效示数范围，总体的状态数量是有限的，因此是一个有限状态机。

各种状态机的应用场景各不相同，在面对工作过程建模这类问题时，有限状态机是较为常用的。同时有限状态机也是使用状态图进行建模的过程方法论中最为基础的。作为入门性介绍文章，本文的介绍范围也限定于此。

### (4) 状态机问题的讨论是基于考察时间范围、考察问题范围进行的

哲学上，对于任何一个对象，其能够用以表征不同时刻差异的特征是无穷多的。如果不考虑范围贪大求全，那么所考虑的状态集将会无穷大，将会超越人类的思维理解能力。因此，建模过程中，应当首先明确所考虑的问题范围，限定边界，以将复杂的问题化简、将不可能的问题转为可能。

同样，在时间上，对象的状态的可能值范围也是随时间变化的。若试图建立一个模型囊括对象所有时间上的情形，那么仍将会掉入无穷的陷阱。对于状态的建模，仍应采取**宏观小**+**微观大**的方案。选取合适的时间范围，即能够保证状态取值范围的稳定，又能够保证状态取值范围内所有值都具备取值的可能性（即状态取值范围内的**遍历性**）。

> #### 例如

- 讨论路口交通灯的控制问题，最简的考察范围为“灯具的有效工作期内”，将灯具的老化、损毁问题排除在外。
- 而讨论交通系统设备保养维护问题时，则考察范围应当正好相反，将灯具的老化、损毁纳入考量，而此时具体这个灯何时亮起何时熄灭则不是考察范围。

未经专业训练的建模者在这个问题上是最易犯错的，往往担心考虑不足，不能够适度控制考察范围，而陷入了“***吾生也有涯，而知也无涯 。以有涯随无涯，殆已。\***”的困境。数学本身的方法论中心思想是**化简**，人类的思维能力相对于茫茫知识的海洋，仅仅是一叶扁舟。面临超越自身能力范围的问题时，通过可靠的方法将其转化为若干较为简化而能够被处理的问题，这样才能最终解决问题。一步到位的做法永远仅仅只能起到望梅止渴的而已。切记！切记！

## 2. 状态机的概念、画法

如前文所述，状态机是指面对**一个对象**，针对**所考察的状态**，其**所有**可能状态**取值**以及这些状态**取值之间的流转关系**的**整体描述**。

状态机图则是进行上述描述的一种有效工具。当然，还存在其它描述方法，例如列表法、公式法等，不过本文仍将重点放在状态机图的使用上。

> #### 画法

- 以方框或圆框表示一个状态可取值，简称为状态，在状态内部或旁边标注所取之值。
- 在状态之间使用有向箭头表示状态之间的流转，从流出状态指向流入状态，流转线条上标注流转条件，若为自发流转，则不标注。
- 实际的运用中可能会为状态和流转作更多标注、样式，但不应当变更状态作为图形结点、流转作为有向箭头的基本约定。

> #### 例图

![img](https:////upload-images.jianshu.io/upload_images/286746-45d72c66624d6f83.png?imageMogr2/auto-orient/strip|imageView2/2/w/800/format/webp)

基本画法

这里特别需要将前述概括中的若干重点进行加强，以下分别说明。

### (1) 一幅图之内应当仅讨论一个对象的状态

如前文所述，一个状态机表征的是唯一的对象，一幅状态机图应当仅绘制一个对象的状态流转。任何多余一个以上的对象的状态若出现在同一幅图中，均是概念混淆的错误。当对象状态结构较复杂时，可以用多幅图联合描述一个对象，但任何一个图中均应仅谈论这个对象。

> #### 例图

![img](https:////upload-images.jianshu.io/upload_images/286746-3715a517769f9ec5.png?imageMogr2/auto-orient/strip|imageView2/2/w/800/format/webp)

仅讨论一个对象的状态，若讨论的对象仅仅是灯具，那么右边的画法是正确的，而左边是错误的

### (2) 目标对象的状态取值应当是有限的，一套图内应当画出所有状态取值

如前文所述，应当在限定的时间范围、限定的讨论范围内选择状态取值范围，而且针对我们所讨论的有限状态机，可取状态值的数量应当是有限的。因此在一套状态机图中，应当画出所有的状态取值。

不应当采取走一步看一步的画法，而应当在制图前首先考虑状态可能取值的数量，确定后再进行绘图。绘图完成后应当进行数量上的校验。

当然，不排除前期思考存在疏漏的可能，也不排除冗余的可能，可以在绘图过程中进行修订调整，但是思考的路线应当秉持正确的顺序。

### (3) 应当有唯一的初始状态，可以有终止状态也可以没有

讨论对象的状态，主要的目的是讨论对象当前在哪个状态值上，发生什么事，之后转移到哪个状态值上。如果由此追溯，那么上一个所取得状态值是什么、在上一个是什么这样一路溯源，那么考虑到前文所述的有限时间的要求，在最初的时刻的状态值是什么是必须要进行回答的。这种情况下，必须指定一个初始的状态取值才能够开展下面的工作。因此，绘制状态图时必须指定一个初始状态。

此外一个对象的被考察的状态在同一时刻不能够同时具有两个不同的值，状态取值之间应当是相互排斥的。因此一个对象的初始状态必须是唯一的。

考虑到有限时间的问题，那么对象状态必然也会在最终时刻达到一个最终的值。这个所谓的最终时刻并非人为指定的某个时间点，而是对象的状态进入到一个值，此后就不再发生变化了。这种情形即可认为达到了最终状态。一个对象可能在不同的情况下达到不同的最终状态，因此最终状态可能存在多个。

如果稍微做一点点推广，考虑这样的对象，它的状态不会到达某个永远不再变化的最终状态，而是在状态图中永远不停的变化着。这种情况也是可以进行描述的。此时状态机将不存在终态，这种情况下状态机将永远不停机的运转下去。

当然，对于实际中显然会结束的过程，最终状态是必须的。永不停机的过程在日常生活中实际上是不存在的，因此更多的过程中终态是必不可少的。

> #### 画法

- 初始状态使用实心圆点表示。
- 终止状态使用实心圆点外加圆环表示。
- 还有有其他画法，注意一套图内使用同一画法即可。

### 例图

![img](https:////upload-images.jianshu.io/upload_images/286746-0db21ccb49ffb816.png?imageMogr2/auto-orient/strip|imageView2/2/w/900/format/webp)

可停机与不可停机的状态图画法以及初始、终止状态画法

### (4) 孤立的状态不应当存在，所有状态应可以到达、可以停机

有了初始状态和最终状态，那么对于状态机中的每一个状态取值就有了进一步的要求。

一个状态机具备可遍历性，是指一个状态机中的每个状态取值，都存在一条从初始状态转移过来的流转通路。即每一个状态值都应当在某种情况下自初始状态变化过来。如果某个状态值不满足这个要求，那么目标对象将永远不可能处于这个状态。这种情况下要么是不必要的状态，要么是图画错了。

一个状态机具备可停机性，是指一个状态机中的每个状态取值，都存在一条道路能够流转到最终状态去。否则一旦对象处于了这个不能流转到最终状态的状态取值上之后，便再也不能够到达最终状态了。对于明显可停机的过程，这是错误的。

> #### 注意

- 可停机状态机：所有状态可达、可止。
- 不停机状态机：所有状态可达。

#### 错误例图

![img](https:////upload-images.jianshu.io/upload_images/286746-d626a4b41a2aaa49.png?imageMogr2/auto-orient/strip|imageView2/2/w/495/format/webp)

图中两个突出状态一个是不可达的，一个是不可止的，均为错误画法

### (5) 应当区别于流程图，讨论要点是对象的状态如何变化，而非如何执行某种程序

流程图着重点在于描述一个持续进行的过程自始至终是如何进行的。而状态图描述一个目标对象的状态之间是如何相互转化的。在一些过程的描述方面，流程图和状态图具有相近的描述能力，可以换用。但是应当注意状态图和流程的不同之处，在实际的运用中正确选用。

两者区别的最大之处在于描述问题的切入点间的差异：

> 状态图讨论对象状态的演变，流程图讨论程序过程的推进。

基于这样的切入点之间的差异，两者之间最为显著的特征就是节点上的标注名称的区别。对于流程图，节点一般采用动词标注，用以表示程序设定的动作。而状态图中的节点表达的是对象的状态取值，应当采用**名词**、**形容词**、**副词**进行命名。

在实际的建模中，有一类场景会比较特殊。这类场景所描述的是一个业务过程的开展。业务过程是一个活动性的事物，其本身便是使用动词进行命名的。此类过程的各个环节是整体活动的一部分，往往也需要使用动词进行命名。针对这类活动性的事物，采用状态机进行建模时，似乎会打破前述的命名约定，需要仔细处理。

操作中，为了突出状态机是针对这种活动过程本身进行建模，首先应将这个过程整体作为一个名词所描绘的事物来处理。一般的策略是将这类过程命名为**事务**。例如公文审批过程，可以称为公文审批事务。

这样中心词从动词审批，转换为名词事务。在本质上实现了名词化。之后，对于事务中的各个环节，不得不采用动词描述的，应当添加“前”、“中”、“后”、“未”、“已~”等前后词缀，进行副词化。这样便可进行状态图建模了。

> #### 例图

![img](https:////upload-images.jianshu.io/upload_images/286746-195d7a15f88c6cd9.png?imageMogr2/auto-orient/strip|imageView2/2/w/597/format/webp)

公文审批事务一例，其中审批、废弃两个环节本身为动词，使用副词化方法将其转为适当名称后使用

在实际的运用中，也有直接使用动词本身作为状态节点标注的，这时应视为“~中”形式的简化。但这种方式是不规范的，应当避免。

### 模型校验法

在本节的最后，简要的概括一下状态机建模完成后的校验方法。

一个状态机模型，首先应当进行的校验是基本的拓扑结构校验，即前文提到：

> 拓扑结构校验

- 是否有唯一的起始节点
- 可停机状态机是否有结束节点
- 每个节点是否都可到达
- 可停机状态机的所有节点是否都可终止
- 瞬态是否具有唯一的、自发的流转

其次应进行语义校验，主要检查

> 语义校验

- 所有节点是否描述同一对象
- 所有节点是否有使用名词、形容词、副词进行描述

最后进行模型完备性校验

> 完备性校验

- 预先列出的所有状态是否均已在图中得到体现

模型的完备性校验并非机械性校验，因建模过程中可能存在缩并、拆分、废弃、增加等调整，只能在一定程度上对模型的正确新提供引导。

上述拓扑结构校验和语义校验是检验状态机建模的必要环节，若校验不通过则模型中必然存在错误，但校验通过并不代表模型一定不存在错误。正确的建模技能更多的是建立与长期不懈的学习与训练的基础上的。

# 三、常见结构提要

状态机作图中，常见的几种基本结构是有必要掌握的。

## 1. 条件结构

状态机建模本身通过条件性流转提供了条件选择结构，这是一种自然的内嵌结构。例如前文公文审批例图中的“审批中”分“通过”、“否决”而流向不同的流入态。

实际上，状态机本身的条件流转特征在数学上是完备的，任何一种需要的非并发过程均可由具有条件流转的状态机进行模拟。

## 2. 循环结构

将条件结构适当调整一下，使其中一条流转流向当前状态节点的前级状态节点，形成一个环路，既可构造循环结构。前文公文审批例图中的“决案”状态的“重新修订”流转便是这样的情况。更一般的形式如下图例。

> #### 例图

![img](https:////upload-images.jianshu.io/upload_images/286746-e9080e7d4aafeeb1.png?imageMogr2/auto-orient/strip|imageView2/2/w/559/format/webp)

循环结构，当然这只是其中一种循环形式，只要能够构造出环路结构便可构成循环

## 3. 伺服结构

在实际应用中，有一类特殊的情况相对比较常见。对象相对较长久的出于一个特定中心状态，仅当某些触发性条件发生时，会较为迅速的在某个状态链条中进行跃变，之后又会回到前述特定状态。若具有多个不同快速跃变的状态链条，这样就形成了伺服结构，这个特定的中心状态称为伺服态。

例如收发室老大爷的工作状态在一定简化程度上既可视为具有伺服结构。

> #### 例图

![img](https:////upload-images.jianshu.io/upload_images/286746-9c5a0f5b77f4714c.png?imageMogr2/auto-orient/strip|imageView2/2/w/458/format/webp)

收发室老大爷的伺服工作状态

此类伺服结构在窗口服务类以及引申的服务情境下是非常常见的。

# 四、结语

至此，状态机建模方法与状态机建模过程基本技法的介绍即告一段落。读者能够准确的运用状态机在各种工作场景中开展高效、准确的建模，单单依靠本篇文章的介绍是远远不够的。而且本篇文章立足于基础，对于状态机模型中的并发性问题、信号传递问题、协同问题都没有进行涉足，若希望有进一步了解，可以参阅UML2.0以及其他相关的扩展阅读内容。

业精于勤荒于嬉，在学习状态机建模技术，作者对此是深有体会的，不经期年累月的学习，在概念理解若不得到彻底的提升，是难于掌握这个技术方法的。也望众多读者加油、共勉。

# 扩展阅读

wikipedia 总是不错的入口

- [State Dialgram](https://link.jianshu.com?t=https://en.wikipedia.org/wiki/State_diagram)
- [UML State Diagram](https://link.jianshu.com?t=https://en.wikipedia.org/wiki/UML_state_machine#Basic_UML_state_diagrams)
- [MathWorks, State Machine](https://link.jianshu.com?t=https://www.mathworks.com/videos/tech-talks/state-machines.html)



作者：Esmool
链接：https://www.jianshu.com/p/0fcb22706090
来源：简书
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。